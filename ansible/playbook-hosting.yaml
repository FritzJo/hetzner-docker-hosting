- hosts: all 
  vars_files:
  - ../ansible-config.yml
  tasks:
  - name: Creating folder structure - instances
    become: yes
    file:
      path: /hosting/instances
      state: directory
      mode: 0775
      recurse: yes
  - name: Creating folder structure - scripts
    become: yes
    file:
      path: /hosting/scripts
      state: directory
      mode: 0775
      recurse: yes
  - name: Creating folder structure - secrets
    become: yes
    file:
      path: /hosting/secrets
      state: directory
      mode: 0775
      recurse: yes
  - name: Copy scripts - update.sh
    copy:
      src: ../scripts/update.sh
      dest: /hosting/scripts/update.sh
      mode: 0775
  - name: Copy scripts - backup.sh
    template:
      src: ../scripts/backup.sh
      dest: /hosting/scripts/backup.sh
      mode: 0775
  - name: Copy scripts - update-vps.sh
    template:
      src: ../update-vps.sh
      dest: /hosting/update-vps.sh
      mode: 0775
  - name: Install backup software
    apt:
      name: "restic"
      state: latest
    become: yes
  - name: Copy backup credentials
    copy:
      src: ../secrets/gcp-secret.json
      dest: /hosting/secrets/gcp-secret.json
      mode: 0775
  - name: Create proxy docker network
    become: yes
    command: docker network create proxy
    ignore_errors: yes
  - name: Create dbadmin docker network
    become: yes
    command: docker network create dbadmin
    ignore_errors: yes
  - name: Copy instance files
    copy:
      src: ../instances/
      dest: /hosting/instances/
  - name: Initializing containers
    become: yes
    command: chdir=/hosting/scripts ./update.sh
  - name: Enable auto-updates and configuration changes on reboot
    cron:
      name: "Update containers at reboot"
      special_time: reboot
      job: "/hosting/scripts/update.sh"
  - name: Enable auto-reboot every week
    cron:
      name: "Reboot every week (Sun. 3:30 AM)"
      weekday: "0"
      minute: "30"
      hour: "3"
      job: "/sbin/shutdown -r now"